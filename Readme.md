# Problem

We are building a search bar that lets people do fuzzy search on different Konnect entities (services, routes, nodes). 
you're in charge of creating the backend ingest to power that service built on top of a [CDC stream](https://debezium.io/documentation/reference/stable/connectors/postgresql.html#postgresql-create-events) generated by Debezium

We have provided a jsonl file containing some sample events that can be used to
simulate input stream.


Below are the tasks we want you to complete.

* develop a program that ingests the sample cdc events into a Kafka topic
* develop a program that persists the data from Kafka into Opensearch


## Get started

Run 

```
docker-compose up -d
```

to start a Kakfa cluster. 

The cluster is accessible locally at `localhost:9092` or `kafka:29092` for services running inside the container network.


You can also access Kafka-UI at `localhost:8080` to examine the ingested Kafka messages.

Opensearch is accessible locally at `localhost:9200` or `opensearch-node:9200` 
for services running inside the container network.

You can validate Opensearch is working by running sample queries

Insert
```
curl -X PUT localhost:9200/entities/_doc/1 -H "Content-Type: application/json" -d '{"foo": "bar"}'
{"_index":"cdc","_id":"1","_version":1,"result":"created","_shards":{"total":2,"successful":1,"failed":0},"_seq_no":0,"_primary_term":1}%
```

Search
```
curl localhost:9200/entities/_search  | python -m json.tool
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100   223  100   223    0     0  41527      0 --:--:-- --:--:-- --:--:-- 44600
{
  "took": 21,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": {
      "value": 152,
      "relation": "eq"
    },
    "max_score": 1,
    "hits": [
      {
        "_index": "entities",
        "_id": "1c7efe0f-203a-422c-b97c-760b61c4436d",
        "_score": 1,
        "_source": {
          "type": "service",
          "id": "1c7efe0f-203a-422c-b97c-760b61c4436d",
          "host": "api.cypressregression62.com",
          "name": "gateway-1706812473877",
          "path": "/api/gatewayService/",
          "port": 80,
          "tags": [
            "tag1",
            "tag2"
          ],
          "enabled": true,
          "retries": 5,
          "protocol": "http",
          "created_at": "2024-02-01T18:34:39+00:00",
          "updated_at": "2024-02-01T18:34:39+00:00",
          "read_timeout": 60000,
          "write_timeout": 60000,
          "connect_timeout": 60000,
          "methods": null,
          "paths": null,
          "hosts": null,
          "service_id": null,
          "version": null,
          "hostname": null,
          "last_ping": null,
          "config_hash": null,
          "process_conf": null,
          "connection_state": null,
          "data_plane_cert_id": null,
          "labels": null
        }
      },
      {
        "_index": "entities",
        "_id": "c/04397908-e846-4019-aeaa-2422a1cb7b6c/last_update",
        "_score": 1,
        "_source": {
          "type": "custom",
          "id": "c/04397908-e846-4019-aeaa-2422a1cb7b6c/last_update",
          "host": null,
          "name": null,
          "path": null,
          "port": null,
          "tags": null,
          "enabled": null,
          "retries": null,
          "protocol": null,
          "created_at": null,
          "updated_at": null,
          "read_timeout": null,
          "write_timeout": null,
          "connect_timeout": null,
          "methods": null,
          "paths": null,
          "hosts": null,
          "service_id": null,
          "version": null,
          "hostname": null,
          "last_ping": null,
          "config_hash": null,
          "process_conf": null,
          "connection_state": null,
          "data_plane_cert_id": null,
          "labels": null
        }
      },
      {
        "_index": "entities",
        "_id": "ea2d5c3e-59e8-444d-a439-0b666a107469",
        "_score": 1,
        "_source": {
          "type": "custom",
          "id": "ea2d5c3e-59e8-444d-a439-0b666a107469",
          "host": null,
          "name": "upstream1",
          "path": null,
          "port": null,
          "tags": null,
          "enabled": null,
          "retries": null,
          "protocol": null,
          "created_at": "2024-02-01T18:45:08+00:00",
          "updated_at": "2024-02-01T18:45:08+00:00",
          "read_timeout": null,
          "write_timeout": null,
          "connect_timeout": null,
          "methods": null,
          "paths": null,
          "hosts": null,
          "service_id": null,
          "version": null,
          "hostname": null,
          "last_ping": null,
          "config_hash": null,
          "process_conf": null,
          "connection_state": null,
          "data_plane_cert_id": null,
          "labels": null
        }
      },
      {
        "_index": "entities",
        "_id": "299350fb-a716-4fb9-a44c-f8128dcc6bb2",
        "_score": 1,
        "_source": {
          "type": "node",
          "id": "299350fb-a716-4fb9-a44c-f8128dcc6bb2",
          "host": null,
          "name": null,
          "path": null,
          "port": null,
          "tags": null,
          "enabled": null,
          "retries": null,
          "protocol": null,
          "created_at": "2024-02-01T18:50:57+00:00",
          "updated_at": "2024-02-01T18:58:28+00:00",
          "read_timeout": null,
          "write_timeout": null,
          "connect_timeout": null,
          "methods": null,
          "paths": null,
          "hosts": null,
          "service_id": null,
          "version": "3.5.0.2",
          "hostname": "monitor001-kong-66957d858-s2rd2",
          "last_ping": "2024-02-01T18:58:28+00:00",
          "config_hash": "2b82f5f6bbb7e1712b82f5f6bbb7e171",
          "process_conf": {
            "plugins": [
              "bundled"
            ],
            "lmdb_map_size": "2048m",
            "router_flavor": "traditional_compatible",
            "cluster_max_payload": 16777216
          },
          "connection_state": {
            "is_connected": true
          },
          "data_plane_cert_id": "f93e2fd4-88cb-4a46-b93a-94637f0d8bed",
          "labels": null
        }
      },
      {
        "_index": "entities",
        "_id": "9a52dbdf-bfbd-4a6e-b6f8-7d26836c9b1c",
        "_score": 1,
        "_source": {
          "type": "node",
          "id": "9a52dbdf-bfbd-4a6e-b6f8-7d26836c9b1c",
          "host": null,
          "name": null,
          "path": null,
          "port": null,
          "tags": null,
          "enabled": null,
          "retries": null,
          "protocol": null,
          "created_at": "2024-02-01T19:01:00+00:00",
          "updated_at": "2024-02-01T19:10:20+00:00",
          "read_timeout": null,
          "write_timeout": null,
          "connect_timeout": null,
          "methods": null,
          "paths": null,
          "hosts": null,
          "service_id": null,
          "version": "3.5.0.2",
          "hostname": "monitor001-kong-65d87b464c-9z5g6",
          "last_ping": "2024-02-01T19:10:20+00:00",
          "config_hash": "2b82f5f6bbb7e1712b82f5f6bbb7e171",
          "process_conf": {
            "plugins": [
              "bundled"
            ],
            "lmdb_map_size": "2048m",
            "router_flavor": "traditional_compatible",
            "cluster_max_payload": 16777216
          },
          "connection_state": {
            "is_connected": false
          },
          "data_plane_cert_id": "f93e2fd4-88cb-4a46-b93a-94637f0d8bed",
          "labels": null
        }
      },
      {
        "_index": "entities",
        "_id": "8355769c-62bc-4077-90e0-676ca59effbf",
        "_score": 1,
        "_source": {
          "type": "custom",
          "id": "8355769c-62bc-4077-90e0-676ca59effbf",
          "host": null,
          "name": "cert-manager-solver-pod.foo-namespace.80.svc",
          "path": null,
          "port": null,
          "tags": [
            "k8s-name:cert-manager-solver-pod",
            "k8s-namespace:foo-namespace",
            "k8s-kind:Service",
            "k8s-version:v1"
          ],
          "enabled": null,
          "retries": null,
          "protocol": null,
          "created_at": "2024-02-01T19:10:59+00:00",
          "updated_at": "2024-02-01T19:10:59+00:00",
          "read_timeout": null,
          "write_timeout": null,
          "connect_timeout": null,
          "methods": null,
          "paths": null,
          "hosts": null,
          "service_id": null,
          "version": null,
          "hostname": null,
          "last_ping": null,
          "config_hash": null,
          "process_conf": null,
          "connection_state": null,
          "data_plane_cert_id": null,
          "labels": null
        }
      },
      {
        "_index": "entities",
        "_id": "fe1e2edc-5479-52fe-b0f4-b90d8d5f83ba",
        "_score": 1,
        "_source": {
          "type": "service",
          "id": "fe1e2edc-5479-52fe-b0f4-b90d8d5f83ba",
          "host": "foo-svc.foo-namespace.80.svc",
          "name": "foo-namespace.foo-svc.80",
          "path": "/",
          "port": 80,
          "tags": [
            "k8s-name:foo-svc",
            "k8s-namespace:foo-namespace",
            "k8s-kind:Service",
            "k8s-version:v1"
          ],
          "enabled": true,
          "retries": 5,
          "protocol": "http",
          "created_at": "2024-02-01T19:11:00+00:00",
          "updated_at": "2024-02-01T19:11:00+00:00",
          "read_timeout": 60000,
          "write_timeout": 60000,
          "connect_timeout": 60000,
          "methods": null,
          "paths": null,
          "hosts": null,
          "service_id": null,
          "version": null,
          "hostname": null,
          "last_ping": null,
          "config_hash": null,
          "process_conf": null,
          "connection_state": null,
          "data_plane_cert_id": null,
          "labels": null
        }
      },
      {
        "_index": "entities",
        "_id": "65ebeec1-01a0-5211-85c9-9f688a182c88",
        "_score": 1,
        "_source": {
          "type": "service",
          "id": "65ebeec1-01a0-5211-85c9-9f688a182c88",
          "host": "default-svc.bar-namespace.80.svc",
          "name": "bar-namespace.default-svc.80",
          "path": null,
          "port": 80,
          "tags": [
            "k8s-name:default-svc",
            "k8s-namespace:bar-namespace",
            "k8s-kind:Service",
            "k8s-version:v1"
          ],
          "enabled": true,
          "retries": 5,
          "protocol": "http",
          "created_at": "2024-02-01T19:11:00+00:00",
          "updated_at": "2024-02-01T19:11:00+00:00",
          "read_timeout": 60000,
          "write_timeout": 60000,
          "connect_timeout": 60000,
          "methods": null,
          "paths": null,
          "hosts": null,
          "service_id": null,
          "version": null,
          "hostname": null,
          "last_ping": null,
          "config_hash": null,
          "process_conf": null,
          "connection_state": null,
          "data_plane_cert_id": null,
          "labels": null
        }
      },
      {
        "_index": "entities",
        "_id": "33b2a57d-fca9-4fbc-ba44-e7993efbdcd2",
        "_score": 1,
        "_source": {
          "type": "route",
          "id": "33b2a57d-fca9-4fbc-ba44-e7993efbdcd2",
          "host": null,
          "name": "r1",
          "path": null,
          "port": null,
          "tags": null,
          "enabled": null,
          "retries": null,
          "protocol": null,
          "created_at": "2024-02-01T19:15:08+00:00",
          "updated_at": "2024-02-01T19:15:08+00:00",
          "read_timeout": null,
          "write_timeout": null,
          "connect_timeout": null,
          "methods": null,
          "paths": [
            "/r1"
          ],
          "hosts": null,
          "service_id": null,
          "version": null,
          "hostname": null,
          "last_ping": null,
          "config_hash": null,
          "process_conf": null,
          "connection_state": null,
          "data_plane_cert_id": null,
          "labels": null
        }
      },
      {
        "_index": "entities",
        "_id": "66483f6d-ca55-4893-8332-bd3c0056b431",
        "_score": 1,
        "_source": {
          "type": "service",
          "id": "66483f6d-ca55-4893-8332-bd3c0056b431",
          "host": "mockbin.org",
          "name": "svc1",
          "path": null,
          "port": 80,
          "tags": null,
          "enabled": true,
          "retries": 5,
          "protocol": "http",
          "created_at": "2024-02-01T19:20:11+00:00",
          "updated_at": "2024-02-01T19:20:11+00:00",
          "read_timeout": 60000,
          "write_timeout": 60000,
          "connect_timeout": 60000,
          "methods": null,
          "paths": null,
          "hosts": null,
          "service_id": null,
          "version": null,
          "hostname": null,
          "last_ping": null,
          "config_hash": null,
          "process_conf": null,
          "connection_state": null,
          "data_plane_cert_id": null,
          "labels": null
        }
      }
    ]
  }
}
```

Run

```
docker-compose down
```

to tear down all the services. 

## Resources

* `stream.jsonl` contains cdc events that need to be ingested
* `docker-compose.yaml` contains the skeleton services to help you get started

## Prerequisite
- Make Sure that You Kafka, Zookeeper, OpenSearch is Running
- RUN ```docker-compose up -d ```
- RUN ``` docker network create private-container ``` 

## Project Structure
1. konnectSearch: This is a python Based Service Responsible for following
   1. Create Connection B/W Kafka and OpenSearch
   2. Create OpenSearch Index (entities) if not Present.
   3. Consume & Parsing the CDC events 
   4. Push the Data to Open Search
2. Producer: This is a simple python scritp for producing the cdc event to kafka topic. 



## How to Run konnectSearch:
1. Create docker network name:  private-container
   - RUN ``` docker network create private-container ``` 
2. Change The Directory 
   - RUN ``` cd konnectSearch ```
3. Docker compose
   - Run ``` cd docker-compose up -d```


## How to Run konnectSearch:
1. Install AioKafka (Python Package)
   - RUN ```pip3 install aiokafka[snappy]==0.11.0 ```
2. Change Directory ``` cd producer```
2. RUN ```python3  cdc_event_producer.py```